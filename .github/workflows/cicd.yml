name: Taller CI/CD
run-name: Estamos ejecutando acciones automÃ¡tica.

on: [push]

jobs: 
  MiprimeraAutomatizacion:
    runs-on: ubuntu-latest
    steps:
      - name: Cargar los ficheros de mi repo
        uses: actions/checkout@v6
      - name: Instalar node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Instalar el repositorio
        run: npm install
      - name: Haciendo los test!
        run: npx vitest run
      - name: Build
        run: npm run build
      - name: Start deploy
        env:
          PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
          HOST: ${{vars.EC2_HOST }}
        run: |
          echo "$PRIVATE_KEY" > clave-aws.pem
          chmod 600 clave-aws.pem
          ssh -o StrictHostKeyChecking=no -i clave-aws.pem ubuntu@${HOST} '
            echo "Carpeta: $(pwd)"
            ls -la .
            sudo apt update
            sudo apt install -y apache2
            sudo systemctl enable apache2
            sudo systemctl start apache2
            sudo systemctl status apache2
            mkdir -p ~/app_deploy
          '
          scp -i clave-aws.pem -o StrictHostKeyChecking=no -r ./dist/* ubuntu@${HOST}:~/app_deploy
          ssh -o StrictHostKeyChecking=no -i clave-aws.pem ubuntu@${HOST} '
            sudo mv ~/app_deploy/* /var/www/html/
            sudo chown -R www-data:www-data /var/www/html/
            sudo rm -rf ~/app_deploy
        

      